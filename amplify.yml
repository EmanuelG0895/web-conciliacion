# ============================================
# AWS AMPLIFY BUILD CONFIGURATION
# Para Turborepo + pnpm según documentación oficial
# ============================================

version: 1

applications:
  # ==========================================
  # APLICACIÓN PRINCIPAL: WEB (Router Central)
  # ==========================================
  - appRoot: apps/web
    frontend:
      phases:
        preBuild:
          commands:
            # Instalar pnpm globalmente
            - npm install -g pnpm@10.19.0
            # Instalar dependencias del monorepo
            - pnpm install
        build:
          commands:
            # Ejecutar turbo build solo para la app web
            - pnpm exec turbo run build --filter=web
      artifacts:
        # Directorio de salida relativo a appRoot (apps/web)
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
      # Variables de entorno para producción
      environmentVariables:
        - name: DOCS_DOMAIN
          value: https://docs.tu-dominio.amplifyapp.com
        - name: ALLOWED_ORIGINS
          value: tu-dominio.amplifyapp.com

  # ==========================================
  # APLICACIÓN SECUNDARIA: DOCS (Zona Docs)
  # ==========================================
  - appRoot: apps/docs
    frontend:
      phases:
        preBuild:
          commands:
            # Instalar pnpm globalmente
            - npm install -g pnpm@10.19.0
            # Instalar dependencias del monorepo
            - pnpm install
        build:
          commands:
            # Ejecutar turbo build solo para la app docs
            - pnpm exec turbo run build --filter=docs
      artifacts:
        # Directorio de salida relativo a appRoot (apps/docs)
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
      # Variables de entorno para producción
      environmentVariables:
        - name: ALLOWED_ORIGINS
          value: tu-dominio.amplifyapp.com

