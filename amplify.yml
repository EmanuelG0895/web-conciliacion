# ============================================
# AWS AMPLIFY BUILD CONFIGURATION
# Para arquitectura Multi-Zone con Turborepo
# ============================================

version: 1

applications:
  # ==========================================
  # APLICACIÓN PRINCIPAL: WEB (Router Central)
  # ==========================================
  - appRoot: apps/web
    platform: WEB_COMPUTE
    frontend:
      phases:
        preBuild:
          commands:
            # Instalar pnpm globalmente
            - npm install -g pnpm@10.19.0
            # Navegar a la raíz del repositorio clonado
            - cd $CODEBUILD_SRC_DIR/limpieza-proyecto
            # Instalar dependencias desde la raíz
            - pnpm install --frozen-lockfile
        build:
          commands:
            # Navegar a la raíz del repositorio
            - cd $CODEBUILD_SRC_DIR/limpieza-proyecto
            # Build usando turbo desde la raíz
            - pnpm turbo run build --filter=web
        postBuild:
          commands:
            - echo "Build completed for web app"
            - ls -la $CODEBUILD_SRC_DIR/limpieza-proyecto/apps/web/.next/
      cache:
        paths:
          # Cache de node_modules del workspace
          - limpieza-proyecto/node_modules/**/*
          # Cache de Next.js
          - limpieza-proyecto/apps/web/.next/cache/**/*
          # Cache de pnpm store
          - limpieza-proyecto/.pnpm-store/**/*
      # Variables de entorno para producción
      environmentVariables:
        - name: DOCS_DOMAIN
          value: https://docs.tu-dominio.amplifyapp.com
        - name: ALLOWED_ORIGINS
          value: tu-dominio.amplifyapp.com

  # ==========================================
  # APLICACIÓN SECUNDARIA: DOCS (Zona Docs)
  # ==========================================
  - appRoot: apps/docs
    platform: WEB_COMPUTE
    frontend:
      phases:
        preBuild:
          commands:
            # Instalar pnpm globalmente
            - npm install -g pnpm@10.19.0
            # Navegar a la raíz del repositorio clonado
            - cd $CODEBUILD_SRC_DIR/limpieza-proyecto
            # Instalar dependencias desde la raíz
            - pnpm install --frozen-lockfile
        build:
          commands:
            # Navegar a la raíz del repositorio
            - cd $CODEBUILD_SRC_DIR/limpieza-proyecto
            # Build usando turbo desde la raíz
            - pnpm turbo run build --filter=docs
      cache:
        paths:
          # Cache de node_modules del workspace
          - limpieza-proyecto/node_modules/**/*
          # Cache de Next.js
          - limpieza-proyecto/apps/docs/.next/cache/**/*
          # Cache de pnpm store
          - limpieza-proyecto/.pnpm-store/**/*
      # Variables de entorno para producción
      environmentVariables:
        - name: ALLOWED_ORIGINS
          value: tu-dominio.amplifyapp.com
